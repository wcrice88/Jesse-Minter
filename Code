library("tidyverse")
library("nflfastR")
library("dplyr")
library("ggplot2")
library("ggrepel")
library("nflplotR")
library("nflreadr")

return_scrap <- pbp_2025 %>%
  filter(return_touchdown == "1") %>%
  filter(home_team == "LAC" | away_team == "LAC")
  

vegas_data <- pbp_2025 %>%
  select(game_id, week, total_line, spread_line, season_type, home_score, away_score, home_team, away_team, defteam_score, defteam_score_post, return_touchdown) %>%
  filter (season_type == "REG") %>%
  mutate(non_offensive_score = (return_touchdown*7))

defensive_points_df <- vegas_data %>%
  group_by(game_id) %>%
  summarise(
    non_offensive_score = sum(non_offensive_score, na.rm = TRUE),
    .groups = "drop"
  )

chargers_data <- vegas_data %>%
  left_join(defensive_points_df, by = c("game_id")) %>%
  filter(home_team == "LAC" | away_team == "LAC") %>%
  select(-non_offensive_score.x) %>%
  rename(non_offensive_score = non_offensive_score.y) %>%
  mutate(away_team_defensive_points_allowed = home_score - non_offensive_score,
      implied_home_team_points = ((total_line/2) + (spread_line/2)),
      implied_away_team_points = ((total_line/2) - (spread_line/2)),
      home_team_points_allowed_over_expected = (away_score - implied_away_team_points),
      away_team_points_allowed_over_expected = (away_team_defensive_points_allowed - implied_home_team_points))

minter_poe_data <- chargers_data %>%
  group_by(game_id, week, home_team, away_team) %>%
  summarise(
    home_poe = first(home_team_points_allowed_over_expected),
    away_poe = first(away_team_points_allowed_over_expected),
    .groups = "drop"
  ) %>%
  select(week, home_team, away_team, home_poe, away_poe)

chargers_weekly <- minter_poe_data %>%
  mutate(
    chargers_poe = if_else(home_team == "LAC", home_poe, away_poe)
  )

chargers_weekly <- chargers_weekly %>%
  mutate(
    location = if_else(home_team == "LAC", "H", "A")
  )

chargers_weekly <- chargers_weekly %>%
  mutate(
    opponent = if_else(home_team == "LAC", away_team, home_team)
  )

ggplot(chargers_weekly, aes(x = week, y = chargers_poe, fill = location)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    geom_col(width = 0.6) +
    scale_fill_manual(values = c(H = "skyblue3", A = "gold2")) +
    geom_nfl_logos(
    aes(team_abbr = opponent),
    width = 0.05,
    alpha = 1,
    y = ifelse(chargers_weekly$chargers_poe >= 0,
               chargers_weekly$chargers_poe + 2,
               chargers_weekly$chargers_poe - 2)
  ) +
    annotate(
    "text",
    x = max(chargers_weekly$week) - 0.5,  
    y = max(chargers_weekly$chargers_poe) + 2,
    label = "Fell Short of Predictions for Defense",
    hjust = 1,
    vjust = 0,
    size = 5,
    fontface = "bold",
    color = "red"
  ) +
  annotate(
    "text",
    x = max(chargers_weekly$week) - 0.5,  
    y = min(chargers_weekly$chargers_poe) - 2,
    label = "Bested Predictions for Defense",
    hjust = 1,
    vjust = 1,
    size = 5,
    fontface = "bold",
    color = "darkgreen"
  ) +
    scale_x_continuous(breaks = unique(chargers_weekly$week)) +
    labs(
    title = "Chargers Week-to-Week Defensive Points Allowed Over Expected",
    x = "Week",
    y = "Points Over Expected",
    caption = "Bye Week 12 | Based on implied Vegas point totals, extracts non-offensive points scored by LAC opponents | data: @nflfastR"
  ) +
    theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(face = "bold"),
    plot.title.position = "plot",
    legend.position = "none"
  )

pbp_2021 <- load_pbp(2021)
pbp_2022 <- load_pbp(2022)

five_years <- bind_rows(pbp_2021, pbp_2022, pbp_2023, pbp_2024, pbp_2025)

lac_points_allowed <- five_years %>%
  filter(defteam == "LAC", season_type == "REG") %>%
  group_by(season, game_id) %>%
  summarise(
    opponent_points = max(posteam_score, na.rm = TRUE),
    .groups = "drop"
  )

lac_game_stats <- five_years %>%
  filter(defteam == "LAC", season_type == "REG") %>%
  group_by(season, game_id) %>%
  summarise(
    total_yards_allowed = sum(yards_gained, na.rm = TRUE),
    pass_yards_allowed = sum(passing_yards, na.rm = TRUE),
    rush_yards_allowed = sum(rushing_yards, na.rm = TRUE),
    sacks = sum(sack, na.rm = TRUE),
    turnovers = sum(interception + fumble_lost, na.rm = TRUE),
    .groups = "drop"
  )

lac_game_stats <- lac_game_stats %>%
  left_join(lac_points_allowed, by = c("season", "game_id"))

counting_stats <- lac_game_stats %>%
  group_by(season) %>%
  summarise(
    total_yards_allowed = sum(total_yards_allowed),
    pass_yards_allowed = sum(pass_yards_allowed),
    rush_yards_allowed = sum(rush_yards_allowed),
    points_allowed = sum(opponent_points),
    sacks = sum(sacks),
    turnovers = sum(turnovers),
    games = n(),
    yards_per_game = total_yards_allowed / games,
    passing_yards_per_game = pass_yards_allowed / games,
    rushing_yards_per_game = rush_yards_allowed / games,
    points_per_game = points_allowed / games,
    .groups = "drop"
  ) %>%
  arrange(season)



counting_stats <- counting_stats %>%
  select(
    -total_yards_allowed,
    -rush_yards_allowed,
    -pass_yards_allowed,
    -points_allowed
  ) %>%
  mutate(
    points_per_game_allowed = round(points_per_game, 1),
    yards_per_game_allowed = round(yards_per_game, 1),
    rush_yards_per_game_allowed = round(rushing_yards_per_game, 1),
    pass_yards_per_game_allowed = round(passing_yards_per_game, 1)
    )

counting_stats <- counting_stats %>%
  select(
    -yards_per_game,
    -rushing_yards_per_game,
    -passing_yards_per_game,
    -points_per_game
  )
  
counting_stats <- counting_stats %>%
  select(-games)


yard_stats <- counting_stats %>%
  select(season, pass_yards_per_game_allowed, rush_yards_per_game_allowed) %>%
  pivot_longer(
    cols = -season,
    names_to = "stat",
    values_to = "value"
  ) %>%
  mutate(stat = case_when(
    stat == "pass_yards_per_game_allowed" ~ "Passing Yards Per Game",
    stat == "rush_yards_per_game_allowed" ~ "Rushing Yards Per Game"
  ))


def_stats <- counting_stats %>%
  select(season, sacks, turnovers) %>%
  pivot_longer(
    cols = -season,
    names_to = "stat",
    values_to = "value"
  ) %>%
  mutate(stat = case_when(
    stat == "sacks" ~ "Sacks",
    stat == "turnovers" ~ "Turnovers",
  ))


ggplot(yard_stats, aes(x = factor(season), y = value, fill = stat)) +
  
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  
  geom_text(
    aes(label = round(value, 1)),
    position = position_dodge(width = 0.8),
    vjust = -0.3,
    size = 4
  ) +
  
  annotate(
    "text",
    x = 2,
    y = max(yard_stats$value) + 12,
    label = "2021-2023: Without Minter",
    color = "red",
    fontface = "bold",
    size = 5
  ) +
  annotate(
    "text",
    x = 4.5,
    y = max(yard_stats$value) + 12,
    label = "2024-2025: With Minter",
    color = "darkgreen",
    fontface = "bold",
    size = 5
  ) +
  
  scale_fill_manual(
    values = c(
      "Passing Yards Per Game" = "gold",
      "Rushing Yards Per Game" = "darkblue"
    )
  ) +
  
  labs(
    title = "Chargers Defensive Yardage Stats by Season",
    x = "Season",
    y = "Yards Per Game",
    fill = "Statistic",
    caption = "Per-game regular season statistics against the Chargers defense | data: @nflfastR"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  )

ggplot(def_stats, aes(x = factor(season), y = value, fill = stat)) +
  
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  
  geom_text(
    aes(label = round(value, 1)),
    position = position_dodge(width = 0.8),
    vjust = -0.3,
    size = 4
  ) +
  
  annotate(
    "text",
    x = 2,
    y = max(def_stats$value) + 1.5,
    label = "2021-2023: Without Minter",
    color = "red",
    fontface = "bold",
    size = 5
  ) +
  annotate(
    "text",
    x = 4.5,
    y = max(def_stats$value) + 1.5,
    label = "2024-2025: With Minter",
    color = "darkgreen",
    fontface = "bold",
    size = 5
  ) +
  
  scale_fill_manual(
    values = c(
      "Sacks" = "darkblue",
      "Turnovers" = "gold"
    )
  ) +
  
  labs(
    title = "Chargers Defensive Impact Play Stats by Season",
    x = "Season",
    y = "Value",
    fill = "Statistic",
    caption = "Per-game regular season statistics against the Chargers defense | data: @nflfastR"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  )



def_game_stats <- five_years %>%
  filter(season_type == "REG") %>%
  group_by(season, defteam, game_id) %>%
  summarise(
    rush_yards_allowed = sum(rushing_yards, na.rm = TRUE),
    pass_yards_allowed = sum(passing_yards, na.rm = TRUE),
    points_allowed = max(posteam_score, na.rm = TRUE),
    sacks = sum(sack, na.rm = TRUE),
    turnovers = sum(interception + fumble_lost, na.rm = TRUE),
    .groups = "drop"
  )

def_season_stats <- def_game_stats %>%
  group_by(season, defteam) %>%
  summarise(
    rush_yards_allowed_pg = sum(rush_yards_allowed) / n(),
    pass_yards_allowed_pg = sum(pass_yards_allowed) / n(),
    points_per_game_allowed = sum(points_allowed) / n(),
    sacks = sum(sacks),
    turnovers = sum(turnovers),
    total_yards_pg = rush_yards_allowed_pg + pass_yards_allowed_pg,
    .groups = "drop"
  )

def_season_pct <- def_season_stats %>%
  group_by(season) %>%
  mutate(
    pass_yards_pct = percent_rank(-pass_yards_allowed_pg) * 100,
    points_per_game_pct = percent_rank(-points_per_game_allowed) * 100,
    sacks_pct = percent_rank(sacks) * 100,
    turnovers_pct = percent_rank(turnovers) * 100
  ) %>%
  ungroup()

lac_heatmap <- def_season_pct %>%
  filter(defteam == "LAC") %>%
  select(
    season,
    pass_yards_pct,
    points_per_game_pct,
    sacks_pct,
    turnovers_pct
  ) %>%
  pivot_longer(
    -season,
    names_to = "stat",
    values_to = "percentile"
  ) %>%
  mutate(
    stat = recode(stat,
                  pass_yards_pct = "Passing Yards Allowed",
                  points_per_game_pct = "Points Allowed per Game",
                  sacks_pct = "Sacks",
                  turnovers_pct = "Turnovers"
    ),
    stat = factor(
      stat,
      levels = c(
        "Points Allowed per Game",
        "Passing Yards Allowed",
        "Sacks",
        "Turnovers"
      )
    )
  )

ggplot(lac_heatmap, aes(x = factor(season), y = stat, fill = percentile)) +
  
  geom_tile(color = "white", linewidth = 0.6) +
  
  geom_text(
    aes(label = round(percentile)),
    color = "black",
    size = 4,
    fontface = "bold"
  ) +
  
  scale_fill_gradient(
    low = "white",   
    high = "blue",  
    limits = c(0, 100),
    name = "NFL Percentile"
  ) +
  
  labs(
    title = "Chargers Defense vs NFL (Percentile Heat Map)",
    subtitle = "Darker = Better League Percentile",
    x = "Season",
    y = NULL,
    caption = "Percentile Rank Among All NFL Teams | data: nflfastR"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    axis.text.x = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.grid = element_blank()
  )


def_era_stats <- def_season_stats %>%
  mutate(
    era = ifelse(season <= 2023, "pre", "post")
  ) %>%
  group_by(defteam, era) %>%
  summarise(
    total_yards_allowed_pg = mean(total_yards_pg, na.rm = TRUE),
    .groups = "drop"
  )

percentiles <- def_era_stats %>%
  group_by(era) %>%
  mutate(
    pct = percent_rank(-total_yards_allowed_pg) * 100
  ) %>%
  ungroup()

quadrant_data <- percentiles %>%
  select(defteam, era, pct) %>%
  pivot_wider(names_from = era, values_from = pct) %>%
  rename(
    pre_pct = pre,
    post_pct = post
  )

quadrant_data <- quadrant_data %>%
  mutate(
    quadrant_label = case_when(
      pre_pct < 50 & post_pct < 50 ~ "Consistently Above Average for 5 Years",
      pre_pct > 50 & post_pct > 50 ~ "Consistently Below Average for 5 Years",
      pre_pct > 50 & post_pct < 50 ~ "Improved Over Time",
      pre_pct < 50 & post_pct > 50 ~ "Got Worse Over Time"
    )
  )

ggplot(quadrant_data, aes(x = post_pct, y = pre_pct)) +
  
  geom_rect(aes(xmin=0, xmax=50, ymin=0, ymax=50), fill="#f8d7da", alpha=0.1) + 
  geom_rect(aes(xmin=50, xmax=100, ymin=50, ymax=100), fill="#d4edda", alpha=0.1) +
  geom_rect(aes(xmin=50, xmax=100, ymin=0, ymax=50), fill="white", alpha=0.1) + 
  geom_rect(aes(xmin=0, xmax=50, ymin=50, ymax=100), fill="white", alpha=0.1) + 
  
  geom_nfl_logos(aes(team_abbr = defteam), width = 0.05) +
  
  annotate("text", x = 25, y = 25, label = "Bad", vjust = -2, hjust = 2, fontface="bold", color="red") +
  annotate("text", x = 75, y = 75, label = "Good", fontface="bold", color="darkgreen") +
  annotate("text", x = 75, y = 25, label = "Better Over Time", fontface="bold", color="black") +
  annotate("text", x = 25, y = 75, label = "Worse Over Time", fontface="bold", color="black") +
  
  labs(
    title = "NFL Teams: Total Yards Allowed per Game (Percentile)",
    subtitle = "Pre-Minter (2021–2023) vs Post-Minter (2024–2025)",
    x = "Post-Minter Percentile (2024–2025)",
    y = "Pre-Minter Percentile (2021–2023)",
    caption = "Data: @nflfastR"
  ) +
  
  scale_x_continuous(limits = c(0,100)) +
  scale_y_continuous(limits = c(0,100)) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(face="bold", size=16),
    axis.title = element_text(face="bold")
  )

pbp_def <- pbp_2025 |>
  filter(
    season_type == "REG",
    !is.na(defteam),
    rush == 1 | pass == 1
  )

def_pass <- pbp_def |>
  filter(pass == 1) |>
  group_by(team = defteam) |>
  summarise(def_pass_epa = mean(epa, na.rm = TRUE))

def_rush <- pbp_def |>
  filter(rush == 1) |>
  group_by(team = defteam) |>
  summarise(def_rush_epa = mean(epa, na.rm = TRUE))

pass_mean <- mean(def_pass$def_pass_epa, na.rm = TRUE)
rush_mean <- mean(def_rush$def_rush_epa, na.rm = TRUE)

def_pass |>
  inner_join(def_rush, by = "team") |>
  ggplot(aes(x = def_pass_epa, y = def_rush_epa)) +
  
  geom_rect(
    xmin = -Inf, xmax = pass_mean,
    ymin = -Inf, ymax = rush_mean,
    fill = "#d4edda", alpha = 0.15
  ) +
  
  geom_rect(
    xmin = pass_mean, xmax = Inf,
    ymin = rush_mean, ymax = Inf,
    fill = "#f8d7da", alpha = 0.15
  ) +
  
  geom_hline(
    yintercept = rush_mean,
    linetype = "dashed",
    color = "red",
    linewidth = 0.8
  ) +
  geom_vline(
    xintercept = pass_mean,
    linetype = "dashed",
    color = "red",
    linewidth = 0.8
  ) +
  
  annotate(
    "text",
    x = pass_mean - 0.12, y = rush_mean - 0.12,
    label = "Good at Both",
    color = "darkgreen", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = pass_mean + 0.12, y = rush_mean + 0.12,
    label = "Bad at Both",
    color = "red", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = pass_mean + 0.12, y = rush_mean - 0.12,
    label = "Modern Day Inefficient",
    color = "black", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = pass_mean - 0.12, y = rush_mean + 0.14,
    label = "The Bills",
    color = "black", size = 5, fontface = "bold"
  ) +
  
  nflplotR::geom_nfl_logos(
    aes(team_abbr = team),
    width = 0.05,
    alpha = 0.7
  ) +
  
  labs(
    title = "2025 NFL Defensive EPA per Play",
    subtitle = "Pass vs Rush (The Lower Value the Better)",
    x = "Defensive Pass EPA / Play",
    y = "Defensive Rush EPA / Play",
    caption = "League Average Shown in Red | Data: @nflfastR"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

pbp_fiveyear_def <- five_years |>
  dplyr::filter(
    season_type == "REG",
    !is.na(defteam),
    rush == 1 | pass == 1
  )

def_21_23 <- pbp_fiveyear_def |>
  dplyr::filter(season %in% 2021:2023) |>
  dplyr::group_by(team = defteam) |>
  dplyr::summarise(epa_21_23 = mean(epa, na.rm = TRUE))

def_24_25 <- pbp_fiveyear_def |>
  dplyr::filter(season %in% 2024:2025) |>
  dplyr::group_by(team = defteam) |>
  dplyr::summarise(epa_24_25 = mean(epa, na.rm = TRUE))

def_compare <- def_21_23 |>
  dplyr::inner_join(def_24_25, by = "team")

x_mean <- mean(def_compare$epa_21_23, na.rm = TRUE)
y_mean <- mean(def_compare$epa_24_25, na.rm = TRUE)

ggplot(def_compare, aes(x = epa_21_23, y = epa_24_25)) +
  
  geom_rect(
    xmin = -Inf, xmax = x_mean,
    ymin = -Inf, ymax = y_mean,
    fill = "#d4edda", alpha = 0.15
  ) +
  
  geom_rect(
    xmin = x_mean, xmax = Inf,
    ymin = y_mean, ymax = Inf,
    fill = "#f8d7da", alpha = 0.15
  ) +
  
  geom_vline(
    xintercept = x_mean,
    linetype = "dashed",
    color = "red",
    linewidth = 0.8
  ) +
  geom_hline(
    yintercept = y_mean,
    linetype = "dashed",
    color = "red",
    linewidth = 0.8
  ) +
  
  annotate(
    "text",
    x = x_mean - 0.05, y = y_mean - 0.05,
    label = "Consistently Above Average",
    color = "darkgreen", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = x_mean + 0.0375, y = y_mean + 0.05,
    label = "Consistently Below Average",
    color = "red", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = x_mean + 0.035, y = y_mean - 0.05,
    label = "Improved",
    color = "black", size = 5, fontface = "bold"
  ) +
  annotate(
    "text",
    x = x_mean - 0.05, y = y_mean + 0.06,
    label = "Regressed",
    color = "black", size = 5, fontface = "bold"
  ) +
  
  nflplotR::geom_nfl_logos(
    aes(team_abbr = team),
    width = 0.04,
    alpha = 0.6
  ) +
  
  labs(
    title = "NFL Defensive EPA per Play: Before and With Minter",
    subtitle = "2021–2023 vs 2024–2025 (The Lower Value the Better)",
    x = "Defensive EPA / Play ('21–'23)",
    y = "Defensive EPA / Play ('24-'25)",
    caption = "League Average Shown in Red | Data: nflfastR"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )


def_wpa <- pbp_2025 %>%
  mutate(vegas_def_wpa = -(vegas_wpa)) %>%
  filter(play_type %in% c("run", "pass"),
         qb_kneel == 0,
         qb_spike == 0)

def_wpa_game_basis <- def_wpa %>%
  group_by(game_id, defteam) %>%
  summarise(
    per_play_vegas_def_wpa = mean(vegas_def_wpa, na.rm = TRUE),
    plays = n(),
    .groups = "drop"
  )

def_wpa_season <- def_wpa %>%
  group_by(defteam) %>%
  summarise(
    def_snaps = n(),
    per_play_vegas_def_wpa = mean(vegas_def_wpa, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(per_play_vegas_def_wpa))


plot_data <- def_wpa_season %>%
  left_join(
    teams_colors_logos %>%
      select(team_abbr, team_color),
    by = c("defteam" = "team_abbr")
  )

ggplot(plot_data,
       aes(
         x = per_play_vegas_def_wpa,
         y = reorder(defteam, -per_play_vegas_def_wpa),
         fill = team_color
       )) +
  geom_col(show.legend = FALSE) +
  scale_fill_identity() +
  coord_flip() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  labs(
    title = "Average Defensive Vegas WPA per Play (2025)",
    x = "Vegas WPA per Play (%)",
    y = NULL,
    caption = "Using open-source WP calculation from Vegas pre-game spreads | Values displayed in percent | Excludes kneels, spikes, and non-run/pass plays | Data: @nflfastR"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  geom_text(
    aes(label = scales::percent(per_play_vegas_def_wpa, accuracy = 0.01)),
    vjust = ifelse(plot_data$per_play_vegas_def_wpa > 0, -1, 1),
    size = 3.5
  )

#Defensive Tendencies/Formation Rates: Use Sharp analysis pages (webscrape?) to compile how the Chargers use very particular schemes/combinations (and how do they compare to the Ravens), and then how do offenses attack the Chargers (offensive formations against/personnel/pass over expected rates)
#2025 stats, 2nd (53.9%) in middle open rate and 31st (41.6%) in middle close rate, compared to the Ravens (36.8%, 58.4%, 4th least and 4th most)
#12.9% man-rate vs 81.3% zone rate (2nd largest difference) to 30.7% and 62.7% rates for Ravens, respectively
#Blitzed less than 19% of the time while the Ravens blitzed over 23%
#Chargers and Ravens both lived in sub package and the Chargers stayed in light boxes more than the Ravens (~55% to 44%)
#Add in DVOA for Chargers that is not in R dataset when writing

regular_season <- pbp_2025 %>%
  filter(play_type %in% c("run", "pass"),
         qb_kneel == 0,
         qb_spike == 0,
         season_type == 'REG') %>%
  mutate(pass_oe = (pass_oe/100))

advanced_stats <- regular_season %>%
  mutate(cpoe = (cpoe/100)) %>%
  group_by(defteam) %>%
  summarise(
    def_snaps = n(),
    qb_epa_against = mean(qb_epa, na.rm = TRUE),
    average_pass_oe = mean(pass_oe, na.rm = TRUE),
    average_cpoe = mean(cpoe, na.rm = TRUE),
    average_success_rate = mean(success, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(defteam))

advanced_stats <- advanced_stats %>%
  mutate(qb_epa_against = round(qb_epa_against, 3),
         average_pass_oe = round(average_pass_oe, 3),
         average_cpoe = round(average_cpoe, 3),
         average_success_rate = round(average_success_rate, 3),
         )
advanced_stats <- advanced_stats %>%
  rename("Team" = defteam,
         "Defensive Snaps" = def_snaps,
         "Average QB EPA Against" = qb_epa_against,
         "Average Pass Rate Over Expected" = average_pass_oe,
         "Average Completion Percentage Over Expected" = average_cpoe,
         "Average Success Rate Against" = average_success_rate
         )

install.packages("DT")
library(DT)

datatable(
  advanced_stats,
  rownames = FALSE,
  options = list(
    pageLength = 32,
    filter = "top",
    searchHighlight = TRUE
  )
)



plot_data <- def_wpa_season %>%
  left_join(
    teams_colors_logos %>%
      select(team_abbr, team_color),
    by = c("defteam" = "team_abbr")
  )

ggplot(plot_data,
       aes(
         x = per_play_vegas_def_wpa,
         y = reorder(defteam, -per_play_vegas_def_wpa),
         fill = team_color
       )) +
  geom_col(show.legend = FALSE) +
  scale_fill_identity() +
  coord_flip() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  labs(
    title = "Average Defensive Vegas WPA per Play (2025)",
    x = "Vegas WPA per Play (%)",
    y = NULL,
    caption = "Using open-source WP calculation from Vegas pre-game spreads | Values displayed in percent | Excludes kneels, spikes, and non-run/pass plays | Data: @nflfastR"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  geom_text(
    aes(label = scales::percent(per_play_vegas_def_wpa, accuracy = 0.01)),
    vjust = ifelse(plot_data$per_play_vegas_def_wpa > 0, -1, 1),
    size = 3.5
  )



#Advanced Deep Dive: Might switch title, but would love to use (part) of this chapter to show draft/trade/contractual value for players Minter has and was give during time, plus are there any examples of players who improved mightily (% of cap) between before and after Minter


#Use of draft/cap resources (shows he worked with lots of veteran presence/help and yet got good value out of less in two drafts)
#Only 17th in 2025 defensive DVOA (A positive DVOA but barely) compared to 2024's 8th rank with 12.6% DVOA
#8th in 2025 with a ~41% offensive success rate against and 6th with albeit a higher success rate against at 41.27%
#ON interesting tidbit in 2025 specific success rate and somewhat to epa/play: The Chargers wavered very little in overall defensive advanced statistics based on game context: In or out of garbage time, in or out of the red zone, trailing or leading, at half or the fourth quarter, they hovered very close to the general total value of the statistic unlike most teams that varied
#Second highest cap amount on defense fo LA Chargers, one of 4 teams with 2 $15+ million players on defense (James and Mack)
#Playing with some of the most resources offered, as well as the second least amount of cap on injured reserve throughout the year (not tracked by games played per cap hit, but comfortably behind some teams and ahead of number 32: Seahawks)
#4 2024 mid-round picks, 2 mid-round 2025 picks for defensive players - 5 teams put less draft pick value over the last 2 years than the chargers
#Highest-drafted defensive player injured entire 2025
